---
title: "BGC First Look"
output: html_document
date: "2025-09-19"
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(lubridate)

```

#Plots
```{r}
treatment = tibble(
  plot = c(1:6),
  treatment = rep(c("cont", "warm"), 3)
)


```

# Ingrowth cores

```{r}

ingrowth_cores = read_csv(here("data_raw/BGC_data/csv/TRACE_ingrowth_cores.csv"))
ingrowth_fill = read_csv(here("data_raw/BGC_data/csv/TRACE_ingrowth_cores_fill.csv"))

```


```{r}
fill = ingrowth_fill %>% 
  clean_names() %>% 
  mutate(across(3:16, as.numeric)) %>% 
  mutate(date = mdy(date),
         start = ymd(case_when(date == "2017-11-02" ~ "2017-11-01",
                           date == "2017-03-01" ~ "2017-03-01",
                           date == "2018-07-25" ~ "2017-07-01",
                           date == "2018-09-26" ~ "2018-09-01",
                           date == "2019-03-20" ~ "2019-03-01",
                           date == "2019-11-25" ~ "2019-11-01")),
         end = ymd(case_when(date == "2017-11-02" ~ "2017-11-30",
                           date == "2017-03-01" ~ "2017-03-31",
                           date == "2018-07-25" ~ "2017-07-31",
                           date == "2018-09-26" ~ "2018-09-30",
                           date == "2019-03-20" ~ "2019-03-31",
                           date == "2019-11-25" ~ "2019-11-30"))) %>% 
  group_by(date, start, end) %>% 
  summarise(tc = mean(tc, na.rm = T),
            tn = mean(tn, na.rm = T),
            tc_tn = mean(tc_tn, na.rm = T),
            nh4 = mean(nh4, na.rm = T),
            no3 = mean(no3, na.rm = T),
            nh4_min_rate = mean(nh4_min_rate, na.rm = T),
            no3_min_rate = mean(no3_min_rate, na.rm = T),
            po4 = mean(po4, na.rm = T),
            ext_c = mean(ext_c, , na.rm = T),
            ext_n = mean(ext_n, na.rm = T),
            ubial_c = mean(ubial_c, na.rm = T),
            ubial_n = mean(ubial_n, na.rm = T),
            ubial_p = mean(ubial_p, na.rm = T),
            ubial_c_n = mean(ubial_c_n, na.rm = T)) %>% 
    filter(!is.na(start)) %>% 
  mutate(type = "init")

ingrowth_rm= ingrowth_cores %>% 
  clean_names() %>% 
  mutate(across(6:19, as.numeric)) %>% 
  mutate(date_installed = mdy(date_installed),
         date_removed = mdy(date_removed)) %>% 
  mutate(type = "rm")


ingrowth = ingrowth_cores %>% 
  clean_names() %>% 
  mutate(across(6:19, as.numeric)) %>% 
  mutate(date_installed = mdy(date_installed),
         date_removed = mdy(date_removed)) %>% 
  filter(!is.na(date_installed)) %>% 
  left_join(fill, by = join_by(between(date_installed, start, end)), suffix = c(".rm", ".init")) %>% 
  mutate(
    tc.change = tc.rm - tc.init,
    tn.change = tn.rm - tc.init,
    tc_tn.change = tc_tn.rm - tc_tn.init,
    nh4.change = nh4.rm - nh4.init,
    no3.change = no3.rm - no3.init,
    nh4_min_rate.change = nh4_min_rate.rm - nh4_min_rate.init,
    no3_min_rate.change = no3_min_rate.rm - no3_min_rate.init,
    po4.change = po4.rm - po4.init, 
    ext_c.change = ext_c.rm - ext_c.init,
    ext_n.change = ext_n.rm - ext_n.init,
    ubial_c.change = ubial_c.rm - ubial_c.init,
    ubial_n.change = ubial_n.rm - ubial_n.init,
    ubial_p.change = ubial_p.rm - ubial_p.init,
    ubial_c_n.change = ubial_c_n.rm - ubial_c_n.init
  ) %>% 
  left_join(treatment, by = "plot")

inits = ingrowth %>% 
  select(core, plot, rep, date_installed, date_removed, ends_with(".init")) %>% 
  rename_with(~ gsub(".init", "", .x), ends_with(".init")) %>% 
  mutate(type = "init",
         date = date_installed)

rms = ingrowth %>% 
  select(core, plot, rep, date_installed, date_removed, ends_with(".rm")) %>% 
  rename_with(~ gsub(".rm", "", .x), ends_with(".rm")) %>% 
  mutate(type = "rm",
         date = date_removed)



```

```{r}
ingrowth_tidy = ingrowth %>% 
  group_by(plot, date_removed, date_installed) %>% 
  summarise(tc_percent_mean_traceingrowthcores = mean(tc.rm, na.rm = T),
            tc_percent_SD_traceingrowthcores = sd(tc.rm, na.rm = T),
            tn_percent_mean_traceingrowthcores = mean(tn.rm, na.rm = T),
            tn_percent_SD_traceingrowthcores = sd(tn.rm, na.rm = T),
            tc.tn_ratio_mean_traceingrowthcores = mean(tc_tn.rm, na.rm = T),
            tc.tn_ratio_SD_traceingrowthcores = sd(tc_tn.rm, na.rm = T),
            nh4_ugN.gsoil_mean_traceingrowthcores = mean(nh4.rm, na.rm = T),
            nh4_ugN.gsoil_SD_traceingrowthcores = sd(nh4.rm, na.rm = T),
            no3_ugN.gsoil_mean_traceingrowthcores = mean(no3.rm, na.rm = T),
            no3_ugN.gsoil_SD_traceingrowthcores = sd(no3.rm, na.rm = T),
            nh4minrate_ugN.gsoil.day_mean_traceingrowthcores = mean(nh4_min_rate.rm, na.rm = T),
            nh4minrate_ugN.gsoil.day_SD_traceingrowthcores = sd(nh4_min_rate.rm, na.rm = T),
            no3_min_rate_ugN.gsoil.day_mean_traceingrowthcores = mean(no3_min_rate.rm, na.rm = T),
            no3_min_rate_ugN.gsoil.day_SD_traceingrowthcores = sd(no3_min_rate.rm, na.rm = T),
            po4_ugP.gsoil_mean_traceingrowthcores = mean(po4.rm, na.rm = T),
            po4_ugP.gsoil_SD_traceingrowthcores = sd(po4.rm, na.rm = T),
            ext.c_ug.gsoil_mean_traceingrowthcores = mean(ext_c.rm, na.rm = T),
            ext.c_ug.gsoil_SD_traceingrowthcores = sd(ext_c.rm, na.rm = T),
            ext.n_ug.gsoil_mean_traceingrowthcores = mean(ext_n.rm, na.rm = T),
            ext.n_ug.gsoil_SD_traceingrowthcores = sd(ext_n.rm, na.rm = T),
            ubial.c_ug.gsoil_mean_traceingrowthcores = mean(ubial_c.rm, na.rm = T),
            ubial.c_ug.gsoil_SD_traceingrowthcores = sd(ubial_c.rm, na.rm = T),
            ubial.n_ug.gsoil_mean_traceingrowthcores = mean(ubial_n.rm, na.rm = T),
            ubial.n_ug.gsoil_SD_traceingrowthcores = sd(ubial_n.rm, na.rm = T),
            ubial.p_ug.gsoil_mean_traceingrowthcores = mean(ubial_p.rm, na.rm = T),
            ubial.p_ug.gsoil_SD_traceingrowthcores = sd(ubial_p.rm, na.rm = T),
            ubial.c.n_ratio_mean_traceingrowthcores = mean(ubial_c_n.rm, na.rm = T),
            ubial.c.n_ratio_SD_traceingrowthcores = sd(ubial_c_n.rm, na.rm = T),
            tc.change_percent_mean_traceingrowthcores = mean(tc.change, na.rm = T),
            tc.change_percent_SD_traceingrowthcores = sd(tc.change, na.rm = T),
            tn.change_percent_mean_traceingrowthcores = mean(tn.change, na.rm = T),
            tn.change_percent_SD_traceingrowthcores = sd(tn.change, na.rm = T),
            tc.tn.change_ratio_mean_traceingrowthcores = mean(tc_tn.change, na.rm = T),
            tc.tn.change_ratio_SD_traceingrowthcores = sd(tc_tn.change, na.rm = T),
            nh4.change_ugN.gsoil_mean_traceingrowthcores = mean(nh4.change, na.rm = T),
            nh4.change_ugN.gsoil_SD_traceingrowthcores = sd(nh4.change, na.rm = T),
            no3.change_ugN.gsoil_mean_traceingrowthcores = mean(no3.change, na.rm = T),
            no3.change_ugN.gsoil_SD_traceingrowthcores = sd(no3.change, na.rm = T),
            nh4_min_rate.change_ugN.gsoil.day_mean_traceingrowthcores = mean(nh4_min_rate.change, na.rm = T),
            nh4_min_rate.change_ugN.gsoil.day_SD_traceingrowthcores = sd(nh4_min_rate.change, na.rm = T),
            no3_min_rate.change_ugN.gsoil.day_mean_traceingrowthcores = mean(no3_min_rate.change, na.rm = T),
            no3_min_rate.change_ugN.gsoil.day_SD_traceingrowthcores = sd(no3_min_rate.change, na.rm = T),
            po4.change_ugP.gsoil_mean_traceingrowthcores = mean(po4.change, na.rm = T),
            po4.change_ugP.gsoil_SD_traceingrowthcores = sd(po4.change, na.rm = T),
            ext.c.change_ug.gsoil_mean_traceingrowthcores = mean(ext_c.change, na.rm = T),
            ext.c.change_ug.gsoil_SD_traceingrowthcores = sd(ext_c.change, na.rm = T),
            ext.n.change_ug.gsoil_mean_traceingrowthcores = mean(ext_n.change, na.rm = T),
            ext.n.change_ug.gsoil_SD_traceingrowthcores = sd(ext_n.change, na.rm = T),
            ubial.c.change_ug.gsoil_mean_traceingrowthcores = mean(ubial_c.change, na.rm = T),
            ubial.c.change_ug.gsoil_SD_traceingrowthcores = sd(ubial_c.change, na.rm = T),
            ubial.n.change_ug.gsoil_mean_traceingrowthcores = mean(ubial_n.change, na.rm = T),
            ubial.n.change_ug.gsoil_SD_traceingrowthcores = sd(ubial_n.change, na.rm = T),
            ubial.p.change_ug.gsoil_mean_traceingrowthcores = mean(ubial_p.change, na.rm = T),
            ubial.p.change_ug.gsoil_SD_traceingrowthcores = sd(ubial_p.change, na.rm = T),
            ubial.c.n.change_ug.gsoil_mean_traceingrowthcores = mean(ubial_c_n.change, na.rm = T),
            ubial.c.n.change_ug.gsoil_SD_traceingrowthcores = sd(ubial_c_n.change, na.rm = T)) %>% 
  rename(date = date_removed)


write_csv(ingrowth_tidy, file = here("data_cleaned/ingrowth_cores.csv"), na = "")

```



```{r}



ggplot(ingrowth) + 
  geom_segment(aes(x = date_installed, xend = date_removed,
                   y = po4.init, yend = po4.rm, color = as.factor(date))) +
  facet_wrap(plot~., nrow = 3) +
  scale_x_date(date_breaks = "3 month", date_labels = "%b-%Y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 


```




# Porewater Chemistry

```{r}
pwc_data = read_csv(here("data/BGC_data/csv/TRACE_porewater_chemistry.csv"), skip = 1)
```

```{r}
pwc = pwc_data %>% 
  clean_names() %>% 
  separate_wider_delim(sample_id, delim = "-", names = c("plot", "depth"), too_few = "align_start") %>% 
  mutate(date = mdy(sample_name)) %>% 
  filter(!is.na(plot),
         !is.na(depth)) %>% 
  rename(volume = x4)
  
## ASK Gabriel what the columns mean

```

```{r}
ggplot(pwc, aes(x = date, y = mg_tdn)) +
  geom_point() + 
  facet_wrap(plot~depth, nrow = 6, ncol = 3) +
  scale_x_date(date_breaks = "3 month", date_labels = "%b-%Y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```

# Lysimiter

```{r}

lys_chem_raw = read_csv(here("data/BGC_data/csv/TRACE_surface_lysimiter_chemistry.csv"))

```

```{r}
lys_chem = lys_chem_raw %>% 
  janitor::clean_names() %>%
  mutate(date = mdy(date)) %>% 
  mutate(across(3:7, as.numeric))
```

```{r}
ggplot(lys_chem, aes(x = date, y = npoc_ug)) + 
  geom_point() + 
  facet_wrap(plot~., nrow = 3, ncol = 2) +
  scale_x_date(date_breaks = "3 month", date_labels = "%b-%Y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Resin

```{r}
resin_data = read_csv(here("data/BGC_data/csv/TRACE_resin.csv"))
```

```{r}
resin = resin_data %>% 
  clean_names() %>% 
  mutate(installed = dmy(installed),
         removed = dmy(removed),
         across(7:8, as.numeric))
  
```

